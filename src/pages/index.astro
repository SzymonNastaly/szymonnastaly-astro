---
import { getCollection, getEntry, render } from 'astro:content';
import Layout from '../layouts/Layout.astro';
import { formatDate } from '../lib/utils';

// Get all published posts, sorted by date (newest first)
const posts = await getCollection('posts', ({ data }) => !data.draft);
posts.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

// Get home page content if it exists
const homePage = await getEntry('pages', 'home');
let HomeContent = null;
if (homePage) {
  const rendered = await render(homePage);
  HomeContent = rendered.Content;
}
---

<Layout title="Szymon Nastaly">
  {HomeContent && (
    <section class="home-intro mb-12 pb-10 border-b border-border prose-warm">
      <HomeContent />
    </section>
  )}

  <section>
    <h2 class="text-2xl font-semibold mb-8 text-charcoal">Blog</h2>
    {posts.length === 0 ? (
      <p class="text-muted">No posts found.</p>
    ) : (
      <ul class="flex flex-col gap-10">
        {posts.map((post) => (
          <li>
            <article class="group">
              <a href={`/posts/${post.id}/`} class="no-underline block">
                <h3 class="text-xl font-medium text-charcoal group-hover:text-terracotta transition-colors mb-2 leading-snug">
                  {post.data.title}
                </h3>
              </a>
              <time
                datetime={post.data.date.toISOString()}
                class="text-sm text-muted block mb-3"
              >
                {formatDate(post.data.date)}
              </time>
              {post.data.description && (
                <p class="text-muted leading-relaxed">
                  {post.data.description}
                </p>
              )}
            </article>
          </li>
        ))}
      </ul>
    )}
  </section>
</Layout>
